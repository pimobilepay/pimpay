// -----------------------------------------------------------------------------
// CONFIGURATION GÉNÉRALE
// -----------------------------------------------------------------------------
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// UTILISATEURS & PROFIL
// -----------------------------------------------------------------------------
model User {
  id             String    @id @default(cuid())
  phone          String    @unique
  email          String?   @unique
  username       String?   @unique
  password       String?
  pin            String?
  refreshToken   String?   @unique

  firstName      String?
  lastName       String?
  lastName2      String?
  middleName     String?
  nativeName     String?
  name           String?
  avatar         String?

  gender         String?
  country        String?
  city           String?
  address        String?
  postalCode     String?
  provinceState  String?
  birthDate      DateTime?
  countryOfBirth String?
  latitude       Float?
  longitude      Float?

  nationality    String?
  idType         String?
  idNumber       String?
  idDeliveryDate DateTime?
  idExpiryDate   DateTime?
  idCountry      String?

  occupation     String?
  sourceOfFunds  String?
  kycFrontUrl    String?
  kycBackUrl     String?
  kycSelfieUrl   String?
  kycSubmittedAt DateTime?
  kycVerifiedAt  DateTime?
  kycReason      String?

  referralCode   String?   @unique @default(cuid())
  referredById   String?
  referredBy     User?     @relation("Referrals", fields: [referredById], references: [id])
  referrals      User[]    @relation("Referrals")
  dailyLimit     Float     @default(1000)
  monthlyLimit   Float     @default(10000)

  role           UserRole   @default(USER)
  kycStatus      KycStatus  @default(NONE)
  status         UserStatus @default(ACTIVE)

  autoApprove         Boolean    @default(false)
  twoFactorEnabled    Boolean    @default(false)
  twoFactorSecret     String?
  failedLoginAttempts Int        @default(0)
  lastLoginAt         DateTime?
  lastLoginIp         String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  walletAddress  String? @unique
  piUserId       String? @unique

  wallets          Wallet[]
  vaults           Vault[]
  stakings         Staking[]
  beneficiaries    Beneficiary[]
  transactionsFrom Transaction[]   @relation("tx_from_user")
  transactionsTo   Transaction[]   @relation("tx_to_user")
  virtualCards     VirtualCard[]
  sessions         Session[]
  notifications    Notification[]
  qrPayments       QRPayment[]
  auditLogs        AuditLog[]      @relation("admin_actions")
  targetLogs       AuditLog[]      @relation("target_user")
  securityLogs     SecurityLog[]
  supportTickets   SupportTicket[]
  merchantProfile  Merchant?       @relation("user_merchant")
  swapQuotes       SwapQuote[]
}

// -----------------------------------------------------------------------------
// FINANCE & ÉPARGNE
// -----------------------------------------------------------------------------
model Wallet {
  id            String     @id @default(cuid())
  userId        String
  balance       Float      @default(0)
  frozenBalance Float      @default(0)
  currency      String     @default("PI")
  type          WalletType @default(PI)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionsFrom Transaction[] @relation("tx_from_wallet")
  transactionsTo   Transaction[] @relation("tx_to_wallet")

  @@unique([userId, currency])
  @@index([userId])
}

model SwapQuote {
  id             String   @id @default(cuid())
  userId         String
  fromAmount     Float
  toAmount       Float
  rate           Float
  targetCurrency String
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemConfig {
  id                 String    @id @default("GLOBAL_CONFIG")
  appVersion         String    @default("1.0.0")
  forceUpdate        Boolean   @default(false)
  globalAnnouncement String?   @db.Text
  maintenanceMode    Boolean   @default(false)
  maintenanceUntil   DateTime?
  transactionFee     Float     @default(0.01)
  minWithdrawal      Float     @default(1.0)
  maxWithdrawal      Float     @default(5000.0)
  consensusPrice     Float     @default(314159.0)
  stakingAPY         Float     @default(15.0)

  totalVolumePi      Float     @default(0.0)
  totalUsers         Int       @default(0)
  totalProfit        Float     @default(0.0)
  lastBackupAt       DateTime  @default(now())

  updatedAt          DateTime  @updatedAt
}

model DailyStats {
  id              String   @id @default(cuid())
  date            DateTime @unique @default(now())
  totalUsers      Int      @default(0)
  totalVolume     Float    @default(0.0)
  consensusPrice  Float    @default(0.0)
  stakingAPY      Float    @default(0.0)
  activeUsers     Int      @default(0)
}

model Vault {
  id           String    @id @default(cuid())
  userId       String
  name         String
  amount       Float     @default(0)
  targetAmount Float?
  interestRate Float     @default(0)
  lockUntil    DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Staking {
  id            String    @id @default(cuid())
  userId       String
  amount        Float
  apy           Float
  startDate     DateTime  @default(now())
  endDate       DateTime?
  isActive      Boolean   @default(true)
  rewardsEarned Float     @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Beneficiary {
  id           String   @id @default(cuid())
  userId       String
  name         String
  lastname     String?
  firstname    String?
  msisdn       String?
  email        String?
  accountInfo  String
  provider     String
  relationship String?
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// -----------------------------------------------------------------------------
// TRANSACTIONS
// -----------------------------------------------------------------------------
model Transaction {
  id           String            @id @default(cuid())
  reference    String            @unique
  externalId   String?           @unique
  blockchainTx String?           @unique

  amount       Float
  fee          Float             @default(0)
  netAmount    Float?
  currency     String            @default("PI")
  destCurrency String?

  wholesaleFxRate Float?
  retailRate      Float?
  retailFee       Float?

  purpose        String?
  status         TransactionStatus @default(PENDING)
  statusClass    String?
  description    String?
  note           String?
  metadata       Json?
  createdAt      DateTime          @default(now())

  bankBic       String?
  accountNumber String?
  accountName   String?
  operatorId    String?
  countryCode   String?

  fromUserId   String?
  fromUser     User?    @relation("tx_from_user", fields: [fromUserId], references: [id])
  fromWalletId String?
  fromWallet   Wallet?  @relation("tx_from_wallet", fields: [fromWalletId], references: [id])

  toUserId     String?
  toUser       User?    @relation("tx_to_user", fields: [toUserId], references: [id])
  toWalletId   String?
  toWallet     Wallet?  @relation("tx_to_wallet", fields: [toWalletId], references: [id])

  qrPaymentId String?
  qrPayment   QRPayment? @relation(fields: [qrPaymentId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([reference])
  @@index([externalId])
}

model Merchant {
  id              String   @id @default(cuid())
  userId          String?  @unique
  name            String
  description     String?
  category        String
  address         String
  city            String
  country         String
  latitude        Float
  longitude       Float
  piPaymentStatus String   @default("ACCEPTED")
  rating          Float    @default(0.0)
  logoUrl         String?
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user            User?    @relation("user_merchant", fields: [userId], references: [id])
}

// -----------------------------------------------------------------------------
// CARTES VIRTUELLES & QR
// -----------------------------------------------------------------------------
model VirtualCard {
  id                String   @id @default(cuid())
  userId            String
  type              CardType @default(CLASSIC)
  number            String   @unique
  exp               String
  cvv               String?
  holder            String
  brand             String   @default("VISA")

  cardPin           String?
  isFrozen          Boolean  @default(false)

  dailyLimit        Float    @default(1000)
  totalSpent        Float    @default(0)
  allowedCurrencies String[] @default(["USD", "PI"])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QRPayment {
  id        String   @id @default(cuid())
  userId    String
  amount    Float?
  currency  String   @default("PI")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

// -----------------------------------------------------------------------------
// SÉCURITÉ & SUPPORT
// -----------------------------------------------------------------------------
model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ip           String?
  userAgent    String?
  deviceName   String?

  os           String?
  browser      String?
  city         String?
  country      String?
  lat          Float?
  lon          Float?

  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model Otp {
  id         String   @id @default(cuid())
  identifier String
  code       String
  type       String   @default("VERIFICATION")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String?
  adminName   String?
  action      String
  targetId    String?
  targetEmail String?
  details     String?  @db.Text
  createdAt   DateTime @default(now())

  admin  User? @relation("admin_actions", fields: [adminId], references: [id])
  target User? @relation("target_user", fields: [targetId], references: [id])
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  ip        String?
  device    String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SupportTicket {
  id        String        @id @default(cuid())
  userId    String
  subject   String
  status    SupportStatus @default(OPEN)
  priority  String        @default("MEDIUM")
  createdAt DateTime      @default(now())
  messages  Message[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  id        String        @id @default(cuid())
  ticketId  String
  senderId  String
  content   String
  createdAt DateTime      @default(now())

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

// MODIFIÉ : Ajout du champ metadata pour supporter les infos de session
model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("info")
  read      Boolean  @default(false)
  metadata  Json?    // <--- C'était ici le problème
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------
enum CardType {
  CLASSIC
  GOLD
  BUSINESS
  ULTRA
}

enum UserRole {
  ADMIN
  USER
  MERCHANT
  AGENT
}

enum UserStatus {
  ACTIVE
  BANNED
  PENDING
  FROZEN
  SUSPENDED
}

enum KycStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum WalletType {
  PI
  FIAT
  CRYPTO
}

enum TransactionType {
  TRANSFER
  WITHDRAW
  DEPOSIT
  PAYMENT
  EXCHANGE
  STAKING_REWARD
  AIRDROP
  CARD_PURCHASE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  SUCCESS
  FAILED
  CANCELLED
}

enum SupportStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

