// -----------------------------------------------------------------------------
// CONFIGURATION GÉNÉRALE
// -----------------------------------------------------------------------------

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// UTILISATEURS & PROFIL
// -----------------------------------------------------------------------------

model User {
  id             String    @id @default(cuid())
  phone          String    @unique
  email          String?   @unique
  username       String?   @unique
  password       String?   // Haché
  pin            String?   // Haché (Code à 4 chiffres)
  refreshToken   String?   @unique

  firstName      String?
  lastName       String?
  name           String?   // Nom d'affichage
  avatar         String?

  // Localisation & Naissance
  country        String?
  city           String?
  address        String?
  birthDate      DateTime?
  latitude       Float?
  longitude      Float?

  // KYC AVANCÉ
  nationality    String?
  idType         String?   // PASSPORT, NATIONAL_ID, DRIVING_LICENSE
  idNumber       String?
  sourceOfFunds  String?
  kycFrontUrl    String?
  kycBackUrl     String?
  kycSelfieUrl   String?
  kycSubmittedAt DateTime?
  kycVerifiedAt  DateTime?
  kycReason      String?

  // LIMITES & CROISSANCE
  referralCode   String?   @unique @default(cuid())
  referredById   String?
  referredBy     User?     @relation("Referrals", fields: [referredById], references: [id])
  referrals      User[]    @relation("Referrals")
  dailyLimit     Float     @default(1000)
  monthlyLimit   Float     @default(10000)

  // STATUTS & RÔLES
  role           UserRole   @default(USER)
  kycStatus      KycStatus  @default(NONE)
  status         UserStatus @default(ACTIVE)

  // ADMIN & SÉCURITÉ
  autoApprove      Boolean    @default(false)
  twoFactorEnabled Boolean    @default(false)
  twoFactorSecret  String?
  failedLoginAttempts Int     @default(0)
  lastLoginAt      DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // WEB3 & PI NETWORK
  walletAddress  String? @unique
  piUserId       String? @unique

  // RELATIONS
  wallets          Wallet[]
  vaults           Vault[]
  stakings         Staking[]
  beneficiaries    Beneficiary[]
  transactionsFrom Transaction[]   @relation("tx_from_user")
  transactionsTo   Transaction[]   @relation("tx_to_user")
  virtualCards     VirtualCard[]
  sessions         Session[]
  notifications    Notification[]
  qrPayments       QRPayment[]
  auditLogs        AuditLog[]      @relation("admin_actions")
  targetLogs       AuditLog[]      @relation("target_user")
  securityLogs     SecurityLog[]
  supportTickets   SupportTicket[]
}

// -----------------------------------------------------------------------------
// FINANCE & ÉPARGNE (WEB3)
// -----------------------------------------------------------------------------

model Wallet {
  id        String     @id @default(cuid())
  userId    String
  balance   Float      @default(0)
  currency  String     @default("PI")
  type      WalletType @default(PI)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionsFrom Transaction[] @relation("tx_from_wallet")
  transactionsTo   Transaction[] @relation("tx_to_wallet")

  @@unique([userId, currency])
  @@index([userId])
}

model SystemConfig {
  id                String   @id @default("GLOBAL_CONFIG")
  maintenanceMode   Boolean  @default(false)
  transactionFee    Float    @default(0.01)
  minWithdrawal     Float    @default(1.0)
  maxWithdrawal     Float    @default(5000.0)
  consensusPrice    Float    @default(314159.0)
  stakingAPY        Float    @default(15.0)
  updatedAt         DateTime @updatedAt
}

model Vault {
  id           String    @id @default(cuid())
  userId       String
  name         String
  amount       Float     @default(0)
  targetAmount Float?
  interestRate Float     @default(0)
  lockUntil    DateTime?
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Staking {
  id          String    @id @default(cuid())
  userId      String
  amount      Float
  apy         Float
  startDate   DateTime  @default(now())
  endDate     DateTime?
  isActive    Boolean   @default(true)
  rewardsEarned Float   @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Beneficiary {
  id          String   @id @default(cuid())
  userId      String
  name        String
  accountInfo String
  provider    String
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// -----------------------------------------------------------------------------
// TRANSACTIONS & PAIEMENTS
// -----------------------------------------------------------------------------

model Transaction {
  id           String            @id
  reference    String            @unique
  blockchainTx String?           @unique
  amount       Float
  fee          Float             @default(0)
  netAmount    Float?
  type         TransactionType
  status       TransactionStatus @default(PENDING)
  description  String?
  note         String?           
  metadata     Json?
  createdAt    DateTime          @default(now())

  fromUserId   String?
  fromUser     User?    @relation("tx_from_user", fields: [fromUserId], references: [id])
  fromWalletId String?
  fromWallet   Wallet?  @relation("tx_from_wallet", fields: [fromWalletId], references: [id])

  toUserId     String?
  toUser       User?    @relation("tx_to_user", fields: [toUserId], references: [id])
  toWalletId   String?
  toWallet     Wallet?  @relation("tx_to_wallet", fields: [toWalletId], references: [id])

  qrPaymentId String?
  qrPayment   QRPayment? @relation(fields: [qrPaymentId], references: [id])

  @@index([fromUserId])
  @@index([toUserId])
  @@index([reference])
}

// -----------------------------------------------------------------------------
// CARTES VIRTUELLES & QR
// -----------------------------------------------------------------------------

model VirtualCard {
  id        String   @id @default(cuid())
  userId    String
  number    String   @unique
  exp       String
  cvv       String?
  holder    String
  brand     String   @default("VISA")
  locked    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QRPayment {
  id        String   @id @default(cuid())
  userId    String
  amount    Float?
  currency  String   @default("PI")
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
}

// -----------------------------------------------------------------------------
// SÉCURITÉ & LOGS
// -----------------------------------------------------------------------------

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  ip           String?
  userAgent    String?
  deviceName   String?
  isActive     Boolean  @default(true)
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Otp {
  id         String   @id @default(cuid())
  identifier String
  code       String
  type       String   @default("VERIFICATION")
  expiresAt  DateTime
  createdAt  DateTime @default(now())
}

model AuditLog {
  id          String   @id @default(cuid())
  adminId     String?
  adminName   String?
  action      String
  targetId    String?
  targetEmail String?
  details     String?
  createdAt   DateTime @default(now())

  admin  User? @relation("admin_actions", fields: [adminId], references: [id])
  target User? @relation("target_user", fields: [targetId], references: [id])
}

model SecurityLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  ip        String?
  device    String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// -----------------------------------------------------------------------------
// SUPPORT & NOTIFICATIONS
// -----------------------------------------------------------------------------

model SupportTicket {
  id        String        @id @default(cuid())
  userId    String
  subject   String
  status    SupportStatus @default(OPEN)
  priority  String        @default("MEDIUM")
  createdAt DateTime      @default(now())
  messages  Message[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  id        String        @id @default(cuid())
  ticketId  String
  senderId  String
  content   String
  createdAt DateTime      @default(now())

  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String   @default("info")
  read      Boolean  @default(false) // <--- FIX: @false est devenu @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// ENUMÉRATIONS
// -----------------------------------------------------------------------------

enum UserRole {
  ADMIN
  USER
  MERCHANT
}

enum UserStatus {
  ACTIVE
  BANNED
  PENDING
  FROZEN
}

enum KycStatus {
  NONE
  PENDING
  VERIFIED
  REJECTED
}

enum WalletType {
  PI
  FIAT
  CRYPTO
}

enum TransactionType {
  TRANSFER
  WITHDRAW
  DEPOSIT
  PAYMENT
  EXCHANGE
  STAKING_REWARD
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum SupportStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}
